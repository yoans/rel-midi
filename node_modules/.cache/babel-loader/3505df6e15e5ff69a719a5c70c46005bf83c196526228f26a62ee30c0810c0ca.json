{"ast":null,"code":"import{useEffect,useRef,useState,useCallback}from'react';export const useSynth=()=>{const audioContext=useRef(null);const masterGain=useRef(null);const filterNode=useRef(null);const activeOscillators=useRef({});const[settings,setSettings]=useState({waveform:'sawtooth',attack:0.01,decay:0.1,sustain:0.5,release:0.3,cutoff:2000,resonance:1,masterVolume:0.5});useEffect(()=>{// Initialize Audio Context\nconst AudioContext=window.AudioContext||window.webkitAudioContext;audioContext.current=new AudioContext();// Master Gain\nmasterGain.current=audioContext.current.createGain();masterGain.current.gain.value=settings.masterVolume;// Filter\nfilterNode.current=audioContext.current.createBiquadFilter();filterNode.current.type='lowpass';filterNode.current.frequency.value=settings.cutoff;filterNode.current.Q.value=settings.resonance;// Connect graph\nfilterNode.current.connect(masterGain.current);masterGain.current.connect(audioContext.current.destination);return()=>{if(audioContext.current){audioContext.current.close();}};},[]);useEffect(()=>{if(masterGain.current){masterGain.current.gain.setTargetAtTime(settings.masterVolume,audioContext.current.currentTime,0.01);}if(filterNode.current){filterNode.current.frequency.setTargetAtTime(settings.cutoff,audioContext.current.currentTime,0.01);filterNode.current.Q.setTargetAtTime(settings.resonance,audioContext.current.currentTime,0.01);}},[settings.masterVolume,settings.cutoff,settings.resonance]);const playNote=useCallback(function(note){let velocity=arguments.length>1&&arguments[1]!==undefined?arguments[1]:127;if(!audioContext.current)return;// Resume context if suspended (browser policy)\nif(audioContext.current.state==='suspended'){audioContext.current.resume();}const freq=440*Math.pow(2,(note-69)/12);const now=audioContext.current.currentTime;const vel=velocity/127;const osc=audioContext.current.createOscillator();const gain=audioContext.current.createGain();osc.type=settings.waveform;osc.frequency.setValueAtTime(freq,now);// Envelope\ngain.gain.setValueAtTime(0,now);gain.gain.linearRampToValueAtTime(vel,now+settings.attack);gain.gain.linearRampToValueAtTime(vel*settings.sustain,now+settings.attack+settings.decay);osc.connect(gain);gain.connect(filterNode.current);osc.start(now);// Store reference to stop later\nif(activeOscillators.current[note]){// If note is already playing, stop it first to avoid stuck notes or layering\nstopNote(note);}activeOscillators.current[note]={osc,gain};},[settings]);const stopNote=useCallback(note=>{if(!audioContext.current||!activeOscillators.current[note])return;const{osc,gain}=activeOscillators.current[note];const now=audioContext.current.currentTime;// Release phase\ngain.gain.cancelScheduledValues(now);gain.gain.setValueAtTime(gain.gain.value,now);gain.gain.exponentialRampToValueAtTime(0.001,now+settings.release);osc.stop(now+settings.release+0.1);// Stop slightly after release to ensure silence\n// Cleanup\nsetTimeout(()=>{// disconnect nodes to free memory\nosc.disconnect();gain.disconnect();},(settings.release+0.2)*1000);delete activeOscillators.current[note];},[settings]);const updateSetting=(key,value)=>{setSettings(prev=>({...prev,[key]:value}));};return{playNote,stopNote,settings,updateSetting};};","map":{"version":3,"names":["useEffect","useRef","useState","useCallback","useSynth","audioContext","masterGain","filterNode","activeOscillators","settings","setSettings","waveform","attack","decay","sustain","release","cutoff","resonance","masterVolume","AudioContext","window","webkitAudioContext","current","createGain","gain","value","createBiquadFilter","type","frequency","Q","connect","destination","close","setTargetAtTime","currentTime","playNote","note","velocity","arguments","length","undefined","state","resume","freq","Math","pow","now","vel","osc","createOscillator","setValueAtTime","linearRampToValueAtTime","start","stopNote","cancelScheduledValues","exponentialRampToValueAtTime","stop","setTimeout","disconnect","updateSetting","key","prev"],"sources":["C:/bench/rel-midi/src/SynthEngine.js"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from 'react';\r\n\r\nexport const useSynth = () => {\r\n  const audioContext = useRef(null);\r\n  const masterGain = useRef(null);\r\n  const filterNode = useRef(null);\r\n  const activeOscillators = useRef({});\r\n\r\n  const [settings, setSettings] = useState({\r\n    waveform: 'sawtooth',\r\n    attack: 0.01,\r\n    decay: 0.1,\r\n    sustain: 0.5,\r\n    release: 0.3,\r\n    cutoff: 2000,\r\n    resonance: 1,\r\n    masterVolume: 0.5\r\n  });\r\n\r\n  useEffect(() => {\r\n    // Initialize Audio Context\r\n    const AudioContext = window.AudioContext || window.webkitAudioContext;\r\n    audioContext.current = new AudioContext();\r\n    \r\n    // Master Gain\r\n    masterGain.current = audioContext.current.createGain();\r\n    masterGain.current.gain.value = settings.masterVolume;\r\n    \r\n    // Filter\r\n    filterNode.current = audioContext.current.createBiquadFilter();\r\n    filterNode.current.type = 'lowpass';\r\n    filterNode.current.frequency.value = settings.cutoff;\r\n    filterNode.current.Q.value = settings.resonance;\r\n\r\n    // Connect graph\r\n    filterNode.current.connect(masterGain.current);\r\n    masterGain.current.connect(audioContext.current.destination);\r\n\r\n    return () => {\r\n      if (audioContext.current) {\r\n        audioContext.current.close();\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (masterGain.current) {\r\n      masterGain.current.gain.setTargetAtTime(settings.masterVolume, audioContext.current.currentTime, 0.01);\r\n    }\r\n    if (filterNode.current) {\r\n      filterNode.current.frequency.setTargetAtTime(settings.cutoff, audioContext.current.currentTime, 0.01);\r\n      filterNode.current.Q.setTargetAtTime(settings.resonance, audioContext.current.currentTime, 0.01);\r\n    }\r\n  }, [settings.masterVolume, settings.cutoff, settings.resonance]);\r\n\r\n  const playNote = useCallback((note, velocity = 127) => {\r\n    if (!audioContext.current) return;\r\n    \r\n    // Resume context if suspended (browser policy)\r\n    if (audioContext.current.state === 'suspended') {\r\n      audioContext.current.resume();\r\n    }\r\n\r\n    const freq = 440 * Math.pow(2, (note - 69) / 12);\r\n    const now = audioContext.current.currentTime;\r\n    const vel = velocity / 127;\r\n\r\n    const osc = audioContext.current.createOscillator();\r\n    const gain = audioContext.current.createGain();\r\n\r\n    osc.type = settings.waveform;\r\n    osc.frequency.setValueAtTime(freq, now);\r\n\r\n    // Envelope\r\n    gain.gain.setValueAtTime(0, now);\r\n    gain.gain.linearRampToValueAtTime(vel, now + settings.attack);\r\n    gain.gain.linearRampToValueAtTime(vel * settings.sustain, now + settings.attack + settings.decay);\r\n\r\n    osc.connect(gain);\r\n    gain.connect(filterNode.current);\r\n\r\n    osc.start(now);\r\n\r\n    // Store reference to stop later\r\n    if (activeOscillators.current[note]) {\r\n        // If note is already playing, stop it first to avoid stuck notes or layering\r\n        stopNote(note);\r\n    }\r\n    activeOscillators.current[note] = { osc, gain };\r\n  }, [settings]);\r\n\r\n  const stopNote = useCallback((note) => {\r\n    if (!audioContext.current || !activeOscillators.current[note]) return;\r\n\r\n    const { osc, gain } = activeOscillators.current[note];\r\n    const now = audioContext.current.currentTime;\r\n\r\n    // Release phase\r\n    gain.gain.cancelScheduledValues(now);\r\n    gain.gain.setValueAtTime(gain.gain.value, now);\r\n    gain.gain.exponentialRampToValueAtTime(0.001, now + settings.release);\r\n\r\n    osc.stop(now + settings.release + 0.1); // Stop slightly after release to ensure silence\r\n    \r\n    // Cleanup\r\n    setTimeout(() => {\r\n        // disconnect nodes to free memory\r\n        osc.disconnect();\r\n        gain.disconnect();\r\n    }, (settings.release + 0.2) * 1000);\r\n\r\n    delete activeOscillators.current[note];\r\n  }, [settings]);\r\n\r\n  const updateSetting = (key, value) => {\r\n    setSettings(prev => ({ ...prev, [key]: value }));\r\n  };\r\n\r\n  return {\r\n    playNote,\r\n    stopNote,\r\n    settings,\r\n    updateSetting\r\n  };\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
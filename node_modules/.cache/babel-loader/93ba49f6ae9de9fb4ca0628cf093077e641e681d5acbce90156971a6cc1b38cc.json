{"ast":null,"code":"import React,{useState,useEffect,useCallback,useRef}from'react';import{useSynth}from'./SynthEngine';import Keyboard from'./components/Keyboard';import Controls from'./components/Controls';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function MidiController(){const{playNote,stopNote,settings,updateSetting}=useSynth();const[midiOutputs,setMidiOutputs]=useState([]);const[selectedOutput,setSelectedOutput]=useState(null);const[currentNote,setCurrentNote]=useState(60);// Start at Middle C\nconst[activeNotes,setActiveNotes]=useState([]);// For visual feedback\n// We need a ref for currentNote to access it inside the event listener closure\n// without constantly re-attaching the listener\nconst currentNoteRef=useRef(60);useEffect(()=>{currentNoteRef.current=currentNote;},[currentNote]);// MIDI Access Initialization\nuseEffect(()=>{const getMIDIAccess=async()=>{try{const access=await navigator.requestMIDIAccess();const outputs=Array.from(access.outputs.values());setMidiOutputs(outputs);if(outputs.length>0){setSelectedOutput(outputs[0].id);}}catch(err){console.warn('MIDI access not available:',err);}};getMIDIAccess();},[]);const triggerNote=useCallback(function(note){let velocity=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;// Visual feedback\nsetActiveNotes([note]);// Play internal synth\nplayNote(note);// Send MIDI if output selected\nif(selectedOutput){navigator.requestMIDIAccess().then(access=>{const output=access.outputs.get(selectedOutput);if(output){output.send([0x90,note,velocity]);// Note off after a short duration for percussive feel or let user control?\n// For this relative style, usually we want to hold it? \n// The original code had a timeout for note off. Let's stick to that for now\n// or better, let's handle keyup to stop.\n// But for relative keys, we just trigger.\nsetTimeout(()=>{output.send([0x80,note,0]);stopNote(note);setActiveNotes([]);},500);}});}else{// If no MIDI, we still want to stop the synth note after some time \n// or we could make it monophonic/legato.\n// Let's use a timeout to mimic the original behavior for now.\nsetTimeout(()=>{stopNote(note);setActiveNotes([]);},500);}},[playNote,stopNote,selectedOutput]);// Relative Key Logic\nuseEffect(()=>{const keyMap={'a':-4,'s':-3,'d':-2,'f':-1,' ':0,// Space bar repeats current\n'j':1,'k':2,'l':3,';':4};const handleKeyDown=e=>{if(e.repeat)return;const interval=keyMap[e.key.toLowerCase()];if(interval!==undefined){e.preventDefault();// Prevent scrolling for space\nconst newNote=Math.max(0,Math.min(127,currentNoteRef.current+interval));setCurrentNote(newNote);triggerNote(newNote);}};window.addEventListener('keydown',handleKeyDown);return()=>{window.removeEventListener('keydown',handleKeyDown);};},[triggerNote]);// Allow clicking keyboard to set anchor note\nconst handleVisualKeyClick=note=>{setCurrentNote(note);triggerNote(note);};return/*#__PURE__*/_jsxs(\"div\",{className:\"synth-container\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"Neon Rel-Midi\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"relative-controls-info\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"key-group left\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"A \",/*#__PURE__*/_jsx(\"span\",{children:\"-4\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"S \",/*#__PURE__*/_jsx(\"span\",{children:\"-3\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"D \",/*#__PURE__*/_jsx(\"span\",{children:\"-2\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"F \",/*#__PURE__*/_jsx(\"span\",{children:\"-1\"})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"key-group center\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint space\",children:[\"SPACE \",/*#__PURE__*/_jsx(\"span\",{children:\"REPEAT\"})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-group right\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"J \",/*#__PURE__*/_jsx(\"span\",{children:\"+1\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"K \",/*#__PURE__*/_jsx(\"span\",{children:\"+2\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"L \",/*#__PURE__*/_jsx(\"span\",{children:\"+3\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-hint\",children:[\"; \",/*#__PURE__*/_jsx(\"span\",{children:\"+4\"})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"current-note-display\",children:[\"Current Note: \",/*#__PURE__*/_jsx(\"span\",{children:currentNote})]}),/*#__PURE__*/_jsx(Controls,{settings:settings,updateSetting:updateSetting,midiOutputs:midiOutputs,selectedOutput:selectedOutput,setSelectedOutput:setSelectedOutput}),/*#__PURE__*/_jsx(Keyboard,{activeNotes:activeNotes,onNoteOn:handleVisualKeyClick,onNoteOff:()=>{}// We handle note off via timeout for now in this mode\n})]});}export default MidiController;","map":{"version":3,"names":["React","useState","useEffect","useCallback","useRef","useSynth","Keyboard","Controls","jsx","_jsx","jsxs","_jsxs","MidiController","playNote","stopNote","settings","updateSetting","midiOutputs","setMidiOutputs","selectedOutput","setSelectedOutput","currentNote","setCurrentNote","activeNotes","setActiveNotes","currentNoteRef","current","getMIDIAccess","access","navigator","requestMIDIAccess","outputs","Array","from","values","length","id","err","console","warn","triggerNote","note","velocity","arguments","undefined","then","output","get","send","setTimeout","keyMap","handleKeyDown","e","repeat","interval","key","toLowerCase","preventDefault","newNote","Math","max","min","window","addEventListener","removeEventListener","handleVisualKeyClick","className","children","onNoteOn","onNoteOff"],"sources":["C:/bench/rel-midi/src/MidiController.js"],"sourcesContent":["import React, { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { useSynth } from './SynthEngine';\r\nimport Keyboard from './components/Keyboard';\r\nimport Controls from './components/Controls';\r\n\r\nfunction MidiController() {\r\n  const { playNote, stopNote, settings, updateSetting } = useSynth();\r\n  const [midiOutputs, setMidiOutputs] = useState([]);\r\n  const [selectedOutput, setSelectedOutput] = useState(null);\r\n  const [currentNote, setCurrentNote] = useState(60); // Start at Middle C\r\n  const [activeNotes, setActiveNotes] = useState([]); // For visual feedback\r\n\r\n  // We need a ref for currentNote to access it inside the event listener closure\r\n  // without constantly re-attaching the listener\r\n  const currentNoteRef = useRef(60);\r\n\r\n  useEffect(() => {\r\n    currentNoteRef.current = currentNote;\r\n  }, [currentNote]);\r\n\r\n  // MIDI Access Initialization\r\n  useEffect(() => {\r\n    const getMIDIAccess = async () => {\r\n      try {\r\n        const access = await navigator.requestMIDIAccess();\r\n        const outputs = Array.from(access.outputs.values());\r\n        setMidiOutputs(outputs);\r\n        if (outputs.length > 0) {\r\n          setSelectedOutput(outputs[0].id);\r\n        }\r\n      } catch (err) {\r\n        console.warn('MIDI access not available:', err);\r\n      }\r\n    };\r\n    getMIDIAccess();\r\n  }, []);\r\n\r\n  const triggerNote = useCallback((note, velocity = 100) => {\r\n    // Visual feedback\r\n    setActiveNotes([note]);\r\n\r\n    // Play internal synth\r\n    playNote(note);\r\n\r\n    // Send MIDI if output selected\r\n    if (selectedOutput) {\r\n      navigator.requestMIDIAccess().then(access => {\r\n        const output = access.outputs.get(selectedOutput);\r\n        if (output) {\r\n          output.send([0x90, note, velocity]);\r\n          // Note off after a short duration for percussive feel or let user control?\r\n          // For this relative style, usually we want to hold it? \r\n          // The original code had a timeout for note off. Let's stick to that for now\r\n          // or better, let's handle keyup to stop.\r\n          // But for relative keys, we just trigger.\r\n          setTimeout(() => {\r\n            output.send([0x80, note, 0]);\r\n            stopNote(note);\r\n            setActiveNotes([]);\r\n          }, 500);\r\n        }\r\n      });\r\n    } else {\r\n      // If no MIDI, we still want to stop the synth note after some time \r\n      // or we could make it monophonic/legato.\r\n      // Let's use a timeout to mimic the original behavior for now.\r\n      setTimeout(() => {\r\n        stopNote(note);\r\n        setActiveNotes([]);\r\n      }, 500);\r\n    }\r\n  }, [playNote, stopNote, selectedOutput]);\r\n\r\n  // Relative Key Logic\r\n  useEffect(() => {\r\n    const keyMap = {\r\n      'a': -4,\r\n      's': -3,\r\n      'd': -2,\r\n      'f': -1,\r\n      ' ': 0, // Space bar repeats current\r\n      'j': 1,\r\n      'k': 2,\r\n      'l': 3,\r\n      ';': 4,\r\n    };\r\n\r\n    const handleKeyDown = (e) => {\r\n      if (e.repeat) return;\r\n\r\n      const interval = keyMap[e.key.toLowerCase()];\r\n\r\n      if (interval !== undefined) {\r\n        e.preventDefault(); // Prevent scrolling for space\r\n\r\n        const newNote = Math.max(0, Math.min(127, currentNoteRef.current + interval));\r\n        setCurrentNote(newNote);\r\n        triggerNote(newNote);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, [triggerNote]);\r\n\r\n  // Allow clicking keyboard to set anchor note\r\n  const handleVisualKeyClick = (note) => {\r\n    setCurrentNote(note);\r\n    triggerNote(note);\r\n  };\r\n\r\n  return (\r\n    <div className=\"synth-container\">\r\n      <h1>Neon Rel-Midi</h1>\r\n\r\n      <div className=\"relative-controls-info\">\r\n        <div className=\"key-group left\">\r\n          <div className=\"key-hint\">A <span>-4</span></div>\r\n          <div className=\"key-hint\">S <span>-3</span></div>\r\n          <div className=\"key-hint\">D <span>-2</span></div>\r\n          <div className=\"key-hint\">F <span>-1</span></div>\r\n        </div>\r\n        <div className=\"key-group center\">\r\n          <div className=\"key-hint space\">SPACE <span>REPEAT</span></div>\r\n        </div>\r\n        <div className=\"key-group right\">\r\n          <div className=\"key-hint\">J <span>+1</span></div>\r\n          <div className=\"key-hint\">K <span>+2</span></div>\r\n          <div className=\"key-hint\">L <span>+3</span></div>\r\n          <div className=\"key-hint\">; <span>+4</span></div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"current-note-display\">\r\n        Current Note: <span>{currentNote}</span>\r\n      </div>\r\n\r\n      <Controls\r\n        settings={settings}\r\n        updateSetting={updateSetting}\r\n        midiOutputs={midiOutputs}\r\n        selectedOutput={selectedOutput}\r\n        setSelectedOutput={setSelectedOutput}\r\n      />\r\n\r\n      <Keyboard\r\n        activeNotes={activeNotes}\r\n        onNoteOn={handleVisualKeyClick}\r\n        onNoteOff={() => { }} // We handle note off via timeout for now in this mode\r\n      />\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default MidiController;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}